from currency_app.tasks import get_mono
from currency_app.models import Rate
from unittest.mock import MagicMock


def test_mono(mocker):
    Rate.objects.all().delete()
    mock_json = lambda: [ # noqa
        {"currencyCodeA": 840, "currencyCodeB": 980, "date": 1629407406, "rateBuy": 26.58, "rateSell": 26.7802},
         {"currencyCodeA": 978, "currencyCodeB": 980, "date": 1629407406, "rateBuy": 31.1, "rateSell": 31.4495}, # noqa
         {"currencyCodeA": 643, "currencyCodeB": 980, "date": 1629407406, "rateBuy": 0.36, "rateSell": 0.38},
         {"currencyCodeA": 978, "currencyCodeB": 840, "date": 1629407406, "rateBuy": 1.162, "rateSell": 1.176},
         {"currencyCodeA": 985, "currencyCodeB": 980, "date": 1629420301, "rateBuy": 6.82, "rateSell": 7.02,
          "rateCross": 7.02}, {"currencyCodeA": 826, "currencyCodeB": 980, "date": 1629420216, "rateCross": 36.8673},
         {"currencyCodeA": 392, "currencyCodeB": 980, "date": 1629419665, "rateCross": 0.2447},
         {"currencyCodeA": 756, "currencyCodeB": 980, "date": 1629412369, "rateCross": 29.7648},
         {"currencyCodeA": 156, "currencyCodeB": 980, "date": 1629415842, "rateCross": 4.1267},
         {"currencyCodeA": 784, "currencyCodeB": 980, "date": 1629419828, "rateCross": 7.2865},
         {"currencyCodeA": 971, "currencyCodeB": 980, "date": 1621225573, "rateCross": 0.3583},
         {"currencyCodeA": 8, "currencyCodeB": 980, "date": 1629413708, "rateCross": 0.2579},
         {"currencyCodeA": 51, "currencyCodeB": 980, "date": 1629412219, "rateCross": 0.0547},
         {"currencyCodeA": 973, "currencyCodeB": 980, "date": 1628034406, "rateCross": 0.0417},
         {"currencyCodeA": 32, "currencyCodeB": 980, "date": 1629419973, "rateCross": 0.2752},
         {"currencyCodeA": 36, "currencyCodeB": 980, "date": 1629418753, "rateCross": 19.4025},
         {"currencyCodeA": 944, "currencyCodeB": 980, "date": 1629413544, "rateCross": 15.7579},
         {"currencyCodeA": 50, "currencyCodeB": 980, "date": 1629374129, "rateCross": 0.3158},
         {"currencyCodeA": 975, "currencyCodeB": 980, "date": 1629419732, "rateCross": 16.0506},
         {"currencyCodeA": 48, "currencyCodeB": 980, "date": 1629314622, "rateCross": 71.0377},
         {"currencyCodeA": 108, "currencyCodeB": 980, "date": 1538606522, "rateCross": 0.0158},
         {"currencyCodeA": 96, "currencyCodeB": 980, "date": 1628668181, "rateCross": 19.8353},
         {"currencyCodeA": 68, "currencyCodeB": 980, "date": 1628423499, "rateCross": 3.9311},
         {"currencyCodeA": 986, "currencyCodeB": 980, "date": 1629419852, "rateCross": 5.0267},
         {"currencyCodeA": 72, "currencyCodeB": 980, "date": 1622275293, "rateCross": 2.5976},
         {"currencyCodeA": 933, "currencyCodeB": 980, "date": 1629419663, "rateCross": 10.632},
         {"currencyCodeA": 124, "currencyCodeB": 980, "date": 1629419443, "rateCross": 21.2317},
         {"currencyCodeA": 976, "currencyCodeB": 980, "date": 1629321006, "rateCross": 0.0136},
         {"currencyCodeA": 152, "currencyCodeB": 980, "date": 1629401211, "rateCross": 0.034},
         {"currencyCodeA": 170, "currencyCodeB": 980, "date": 1629419671, "rateCross": 0.0069},
         {"currencyCodeA": 188, "currencyCodeB": 980, "date": 1629413873, "rateCross": 0.0432},
         {"currencyCodeA": 192, "currencyCodeB": 980, "date": 1629321006, "rateCross": 1.1075},
         {"currencyCodeA": 203, "currencyCodeB": 980, "date": 1629420335, "rateCross": 1.2369},
         {"currencyCodeA": 262, "currencyCodeB": 980, "date": 1628870895, "rateCross": 0.1509},
         {"currencyCodeA": 208, "currencyCodeB": 980, "date": 1629417294, "rateCross": 4.2288},
         {"currencyCodeA": 12, "currencyCodeB": 980, "date": 1629361678, "rateCross": 0.1976},
         {"currencyCodeA": 818, "currencyCodeB": 980, "date": 1629420305, "rateCross": 1.712},
         {"currencyCodeA": 230, "currencyCodeB": 980, "date": 1629378658, "rateCross": 0.5902},
         {"currencyCodeA": 981, "currencyCodeB": 980, "date": 1629419085, "rateCross": 8.62},
         {"currencyCodeA": 936, "currencyCodeB": 980, "date": 1629024420, "rateCross": 4.604},
         {"currencyCodeA": 270, "currencyCodeB": 980, "date": 1624650409, "rateCross": 0.5744},
         {"currencyCodeA": 324, "currencyCodeB": 980, "date": 1621350723, "rateCross": 0.0028},
         {"currencyCodeA": 344, "currencyCodeB": 980, "date": 1629414609, "rateCross": 3.4396},
         {"currencyCodeA": 191, "currencyCodeB": 980, "date": 1629420147, "rateCross": 4.1742},
         {"currencyCodeA": 348, "currencyCodeB": 980, "date": 1629420116, "rateCross": 0.0897},
         {"currencyCodeA": 360, "currencyCodeB": 980, "date": 1629419043, "rateCross": 0.0018},
         {"currencyCodeA": 376, "currencyCodeB": 980, "date": 1629416823, "rateCross": 8.3029},
         {"currencyCodeA": 356, "currencyCodeB": 980, "date": 1629414429, "rateCross": 0.358},
         {"currencyCodeA": 368, "currencyCodeB": 980, "date": 1629355670, "rateCross": 0.0183},
         {"currencyCodeA": 364, "currencyCodeB": 980, "date": 1629321006, "rateCross": 0.0006},
         {"currencyCodeA": 352, "currencyCodeB": 980, "date": 1629413600, "rateCross": 0.2104},
         {"currencyCodeA": 400, "currencyCodeB": 980, "date": 1629410279, "rateCross": 37.8263},
         {"currencyCodeA": 404, "currencyCodeB": 980, "date": 1629398415, "rateCross": 0.2448},
         {"currencyCodeA": 417, "currencyCodeB": 980, "date": 1629418244, "rateCross": 0.3164},
         {"currencyCodeA": 116, "currencyCodeB": 980, "date": 1628797873, "rateCross": 0.0065},
         {"currencyCodeA": 408, "currencyCodeB": 980, "date": 1629321006, "rateCross": 12.0818},
         {"currencyCodeA": 410, "currencyCodeB": 980, "date": 1629419166, "rateCross": 0.0229},
         {"currencyCodeA": 414, "currencyCodeB": 980, "date": 1629394664, "rateCross": 89.0666},
         {"currencyCodeA": 398, "currencyCodeB": 980, "date": 1629414576, "rateCross": 0.0624},
         {"currencyCodeA": 418, "currencyCodeB": 980, "date": 1627906149, "rateCross": 0.0028},
         {"currencyCodeA": 422, "currencyCodeB": 980, "date": 1629310954, "rateCross": 0.0022},
         {"currencyCodeA": 144, "currencyCodeB": 980, "date": 1629415131, "rateCross": 0.1344},
         {"currencyCodeA": 434, "currencyCodeB": 980, "date": 1629321006, "rateCross": 5.8812},
         {"currencyCodeA": 504, "currencyCodeB": 980, "date": 1629402653, "rateCross": 2.9825},
         {"currencyCodeA": 498, "currencyCodeB": 980, "date": 1629409718, "rateCross": 1.5281},
         {"currencyCodeA": 969, "currencyCodeB": 980, "date": 1628750227, "rateCross": 0.007},
         {"currencyCodeA": 807, "currencyCodeB": 980, "date": 1629409780, "rateCross": 0.5091},
         {"currencyCodeA": 496, "currencyCodeB": 980, "date": 1603268632, "rateCross": 0.0102},
         {"currencyCodeA": 478, "currencyCodeB": 980, "date": 1629321006, "rateCross": 0.074},
         {"currencyCodeA": 480, "currencyCodeB": 980, "date": 1628684701, "rateCross": 0.6309},
         {"currencyCodeA": 454, "currencyCodeB": 980, "date": 1581405226, "rateCross": 0.0337},
         {"currencyCodeA": 484, "currencyCodeB": 980, "date": 1629420260, "rateCross": 1.3369},
         {"currencyCodeA": 458, "currencyCodeB": 980, "date": 1629419768, "rateCross": 6.3202},
         {"currencyCodeA": 943, "currencyCodeB": 980, "date": 1629122526, "rateCross": 0.4253},
         {"currencyCodeA": 516, "currencyCodeB": 980, "date": 1629400231, "rateCross": 1.7717},
         {"currencyCodeA": 566, "currencyCodeB": 980, "date": 1629408811, "rateCross": 0.0651},
         {"currencyCodeA": 558, "currencyCodeB": 980, "date": 1629326489, "rateCross": 0.7598},
         {"currencyCodeA": 578, "currencyCodeB": 980, "date": 1629416158, "rateCross": 3.0158},
         {"currencyCodeA": 524, "currencyCodeB": 980, "date": 1629204276, "rateCross": 0.2259},
         {"currencyCodeA": 554, "currencyCodeB": 980, "date": 1629325413, "rateCross": 18.6176},
         {"currencyCodeA": 512, "currencyCodeB": 980, "date": 1629391308, "rateCross": 69.5526},
         {"currencyCodeA": 604, "currencyCodeB": 980, "date": 1629378413, "rateCross": 6.5517},
         {"currencyCodeA": 608, "currencyCodeB": 980, "date": 1629382823, "rateCross": 0.5314},
         {"currencyCodeA": 586, "currencyCodeB": 980, "date": 1629409507, "rateCross": 0.1633},
         {"currencyCodeA": 600, "currencyCodeB": 980, "date": 1623790865, "rateCross": 0.004},
         {"currencyCodeA": 634, "currencyCodeB": 980, "date": 1629415126, "rateCross": 7.3602},
         {"currencyCodeA": 946, "currencyCodeB": 980, "date": 1629419540, "rateCross": 6.3862},
         {"currencyCodeA": 941, "currencyCodeB": 980, "date": 1629419896, "rateCross": 0.2669},
         {"currencyCodeA": 682, "currencyCodeB": 980, "date": 1629418252, "rateCross": 7.143},
         {"currencyCodeA": 690, "currencyCodeB": 980, "date": 1629413905, "rateCross": 1.7756},
         {"currencyCodeA": 938, "currencyCodeB": 980, "date": 1629321006, "rateCross": 0.0599},
         {"currencyCodeA": 752, "currencyCodeB": 980, "date": 1629418316, "rateCross": 3.0796},
         {"currencyCodeA": 702, "currencyCodeB": 980, "date": 1629398444, "rateCross": 19.7169},
         {"currencyCodeA": 694, "currencyCodeB": 980, "date": 1628377797, "rateCross": 0.0026},
         {"currencyCodeA": 706, "currencyCodeB": 980, "date": 1629321006, "rateCross": 0.0462},
         {"currencyCodeA": 968, "currencyCodeB": 980, "date": 1591303043, "rateCross": 3.5865},
         {"currencyCodeA": 760, "currencyCodeB": 980, "date": 1629321006, "rateCross": 0.0106},
         {"currencyCodeA": 748, "currencyCodeB": 980, "date": 1629321006, "rateCross": 1.7923},
         {"currencyCodeA": 764, "currencyCodeB": 980, "date": 1629412786, "rateCross": 0.8022},
         {"currencyCodeA": 972, "currencyCodeB": 980, "date": 1629393908, "rateCross": 2.367},
         {"currencyCodeA": 795, "currencyCodeB": 980, "date": 1629321006, "rateCross": 0.0015},
         {"currencyCodeA": 788, "currencyCodeB": 980, "date": 1629412935, "rateCross": 9.6902},
         {"currencyCodeA": 949, "currencyCodeB": 980, "date": 1629420332, "rateCross": 3.1747},
         {"currencyCodeA": 901, "currencyCodeB": 980, "date": 1629354330, "rateCross": 0.9616},
         {"currencyCodeA": 834, "currencyCodeB": 980, "date": 1629396860, "rateCross": 0.0115},
         {"currencyCodeA": 800, "currencyCodeB": 980, "date": 1629035239, "rateCross": 0.0075},
         {"currencyCodeA": 858, "currencyCodeB": 980, "date": 1629409055, "rateCross": 0.621},
         {"currencyCodeA": 860, "currencyCodeB": 980, "date": 1629411626, "rateCross": 0.0025},
         {"currencyCodeA": 704, "currencyCodeB": 980, "date": 1629397866, "rateCross": 0.0011},
         {"currencyCodeA": 950, "currencyCodeB": 980, "date": 1628875135, "rateCross": 0.048},
         {"currencyCodeA": 952, "currencyCodeB": 980, "date": 1629399218, "rateCross": 0.0479},
         {"currencyCodeA": 886, "currencyCodeB": 980, "date": 1543715495, "rateCross": 0.112},
         {"currencyCodeA": 710, "currencyCodeB": 980, "date": 1629415154, "rateCross": 1.8241},
         {"currencyCodeA": 894, "currencyCodeB": 980, "date": 1629321006, "rateCross": 0.0014}
        ]
    requests_get = mocker.patch('requests.get', return_value=MagicMock(json=mock_json))  # noqa
    initial_count = Rate.objects.count()
    get_mono()
    assert Rate.objects.count() == initial_count + 2
    get_mono()
    assert Rate.objects.count() == initial_count + 2
